<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Gestión de Clientes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 40px;
            background-color: #f4f4f4;
        }

        h1 {
            color: #333;
        }

        input,
        button {
            display: block;
            margin: 10px 0;
            padding: 10px;
            width: 300px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
            background-color: white;
        }

        th,
        td {
            border: 1px solid #aaa;
            padding: 10px;
            text-align: left;
        }

        button.edit {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }

        button.delete {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }

        button.logout {
            background-color: #555;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <h1>Gestión de Clientes</h1>

    <!-- Botón Cerrar sesión -->
    <button class="logout" onclick="cerrarSesion()">Cerrar sesión</button>

    <!-- Campo CSRF para JavaScript -->
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="cliente_id" id="cliente_id">
        <input type="text" name="identificacion" placeholder="Número de identificación" required>
        <input type="text" name="nombre" placeholder="Nombre" required>
        <input type="text" name="apellido" placeholder="Apellido" required>
        <input type="date" name="fecha_nacimiento" placeholder="Fecha de nacimiento" required>
        <button type="submit">Guardar Cliente</button>
    </form>

    <table id="tablaClientes">
        <thead>
            <tr>
                <th>Número de Identificación</th>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Fecha de Nacimiento</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for cliente in clientes %}
            <tr>
                <td>{{ cliente.identificacion }}</td>
                <td>{{ cliente.nombre }}</td>
                <td>{{ cliente.apellido }}</td>
                <td>{{ cliente.fecha_nacimiento }}</td>
                <td>
                    <button class="edit" data-id="{{ cliente.id }}" data-identificacion="{{ cliente.identificacion }}"
                        data-nombre="{{ cliente.nombre }}" data-apellido="{{ cliente.apellido }}"
                        data-fecha_nacimiento="{{ cliente.fecha_nacimiento|date:'Y-m-d' }}">
                        Editar
                    </button>
                    <button class="delete" onclick="eliminarCliente(this)" data-id="{{ cliente.id }}">Eliminar</button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5">No hay clientes registrados.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const botonesEditar = document.querySelectorAll('button.edit');
            const form = document.querySelector('form');

            botonesEditar.forEach(boton => {
                boton.addEventListener('click', function () {
                    const id = this.dataset.id;
                    const identificacion = this.dataset.identificacion;
                    const nombre = this.dataset.nombre;
                    const apellido = this.dataset.apellido;
                    const fechaNacimiento = this.dataset.fecha_nacimiento;

                    // Llenar el formulario
                    form.action = `/usuarios/gestion_clientes/${id}/`;
                    form.querySelector('input[name="identificacion"]').value = identificacion;
                    form.querySelector('input[name="nombre"]').value = nombre;
                    form.querySelector('input[name="apellido"]').value = apellido;
                    form.querySelector('input[name="fecha_nacimiento"]').value = fechaNacimiento;

                    // Cambiar el texto del botón
                    form.querySelector('button[type="submit"]').textContent = 'Actualizar Cliente';
                });
            });
        });

        function eliminarCliente(button) {
            const clienteId = button.getAttribute("data-id");
            const confirmar = confirm("¿Estás seguro de que deseas eliminar este cliente?");
            if (confirmar) {
                fetch(`/usuarios/eliminar_cliente/${clienteId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCSRFToken(),
                    },
                })
                .then(response => {
                    if (response.ok) {
                        const fila = button.closest('tr');
                        fila.remove();
                    } else {
                        alert("Error al eliminar el cliente.");
                    }
                });
            }
        }

        function cerrarSesion() {
            fetch("{% url 'logout' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCSRFToken(),
                },
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = "/";
                } else {
                    alert("Error al cerrar sesión.");
                }
            });
        }

        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }
    </script>

</body>
</html>
